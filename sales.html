<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª - Ø±ÙˆØ§Ù‚</title>

<!-- ğŸ” Ø§Ù„Ø£Ù…Ø§Ù† + Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« -->
<script>
const MAX_TIME = 5 * 60 * 1000;
const loggedIn = sessionStorage.getItem("loggedIn");
const lastLogin = sessionStorage.getItem("lastLogin");

if(!loggedIn || !lastLogin || (Date.now() - lastLogin > MAX_TIME)){
  sessionStorage.clear();
  location.href = "login.html";
}

const nav = performance.getEntriesByType("navigation")[0];
if(nav && nav.type === "reload"){
  sessionStorage.clear();
  location.href = "login.html";
}
</script>

<style>
:root{
  --purple:#4b1f5c;
  --bg:#f4f1f6;
}
body{
  margin:0;
  font-family:Tahoma;
  background:var(--bg);
}
.container{
  max-width:95%;
  margin:20px auto;
  background:#fff;
  padding:15px;
  border-radius:12px;
}
h2{
  text-align:center;
  color:var(--purple);
}

.filters{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:10px;
  margin-bottom:15px;
}
input,button{
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  font-family:Tahoma;
}
button{
  background:var(--purple);
  color:#fff;
  border:none;
  cursor:pointer;
}

.summary{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:10px;
  margin:15px 0;
}
.box{
  background:#f4f1f6;
  padding:12px;
  border-radius:10px;
  text-align:center;
  font-weight:bold;
}

table{
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}
th,td{
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
  vertical-align:top;
}
th{
  background:var(--purple);
  color:#fff;
}
.client{
  line-height:1.6;
}

.back{
  margin-top:15px;
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
}
</style>
</head>

<body>

<div class="container">
<h2>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h2>

<!-- ğŸ” Ø§Ù„Ø¨Ø­Ø« -->
<div class="filters">
  <input type="date" id="fromDate">
  <input type="date" id="toDate">
  <button onclick="loadSales()">Ø¨Ø­Ø«</button>
</div>

<!-- ğŸ“Š Ø§Ù„Ù…Ù„Ø®Øµ -->
<div class="summary">
  <div class="box">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…<br><span id="days">0</span></div>
  <div class="box">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª<br><span id="count">0</span></div>
  <div class="box">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØµØ§ÙÙŠ<br><span id="totalNet">0</span></div>
  <div class="box">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†<br><span id="totalDeposit">0</span></div>
  <div class="box">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ (Ø§Ù„ØµØ§ÙÙŠ + Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†)<br><span id="grandTotal">0</span></div>
</div>

<!-- ğŸ“‹ Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
<table>
<thead>
<tr>
<th>#</th>
<th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
<th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</th>
<th>ØªÙØµÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº</th>
</tr>
</thead>
<tbody id="body"></tbody>
</table>

<button class="back" onclick="location.href='index.html'">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
</div>

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbxqp0aagRTRGcIpQGlIjhyjQi2Kw2G-bOJzQt9pv4qj55tIkxAq569TSBjQ5tgOPajp/exec";

function formatDate(d){
  return new Date(d).toLocaleDateString("ar-SA");
}

function daysBetween(a,b){
  const diff = Math.abs(b - a);
  return Math.ceil(diff / (1000*60*60*24)) + 1;
}

function loadSales(){
  const from = fromDate.value;
  const to = toDate.value;
  if(!from || !to) return alert("Ø§Ø®ØªØ± Ø§Ù„ÙØªØ±Ø© ÙƒØ§Ù…Ù„Ø©");

  const d1 = new Date(from);
  const d2 = new Date(to);

  days.textContent = daysBetween(d1,d2);

  fetch(SHEET_URL)
    .then(r => r.json())
    .then(data => {
      const body = document.getElementById("body");
      body.innerHTML = "";

      let countOrders = 0;
      let totalNetSum = 0;
      let totalDepositSum = 0;

      data
        .filter(o =>
          o.status === "ØªÙ…" &&
          o.eventDate &&
          new Date(o.eventDate) >= d1 &&
          new Date(o.eventDate) <= d2
        )
        .forEach((o,i)=>{
          countOrders++;

          const net = Number(o.net || 0);
          const deposit = Number(o.deposit || 0);

          totalNetSum += net;
          totalDepositSum += deposit;

          body.innerHTML += `
          <tr>
            <td>${i+1}</td>
            <td class="client">
              ${o.name || ""}<br>${o.phone || ""}
            </td>
            <td>${formatDate(o.eventDate)}</td>
            <td>
              Ø§Ù„ØµØ§ÙÙŠ: ${net}<br>
              Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†: ${deposit}<br>
              <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨: ${net + deposit}</strong>
            </td>
          </tr>`;
        });

      count.textContent = countOrders;
      totalNet.textContent = totalNetSum;
      totalDeposit.textContent = totalDepositSum;
      grandTotal.textContent = totalNetSum + totalDepositSum;
    });
}
</script>

</body>
</html>
