<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ - Ø±ÙˆØ§Ù‚</title>

<style>
body{
  font-family:Tahoma;
  background:#f4f1f6;
  margin:0;
}
.container{
  max-width:600px;
  margin:30px auto;
  background:#fff;
  padding:20px;
  border-radius:12px;
}
h2{ text-align:center; color:#4b1f5c; }
label{ display:block; margin-top:12px; font-weight:bold; }
input,select,textarea{
  width:100%; padding:10px; margin-top:6px;
  border-radius:8px; border:1px solid #ccc;
}
button{
  width:100%; margin-top:12px; padding:12px;
  border:none; border-radius:10px;
  font-size:16px; cursor:pointer;
}
.save{ background:#4b1f5c; color:#fff; }
.back{ background:#ddd; color:#4b1f5c; }
ul{ padding-right:20px; }
li{ display:flex; justify-content:space-between; }
.remove{ background:none; border:none; color:red; }
.net{ background:#eee; padding:10px; border-radius:8px; margin-top:10px; }
</style>
</head>

<body>

<!-- ğŸ” Ø§Ù„Ø£Ù…Ø§Ù† + Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙ‚Ø· -->
<script>
const MAX_TIME = 5 * 60 * 1000;
const loggedIn = sessionStorage.getItem("loggedIn");
const lastLogin = sessionStorage.getItem("lastLogin");

if(!loggedIn || !lastLogin || (Date.now() - lastLogin > MAX_TIME)){
  sessionStorage.clear();
  location.href = "login.html";
}

const nav = performance.getEntriesByType("navigation")[0];
if (nav && nav.type === "reload") {
  sessionStorage.clear();
  location.href = "login.html";
}
</script>

<div class="container">
<h2 id="title">ØªØ³Ø¬ÙŠÙ„ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>

<label>Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</label>
<input id="customerName" autocomplete="off">

<label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
<input id="phone">

<label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²</label>
<input type="date" id="bookingDate">

<label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</label>
<input type="date" id="eventDate">

<label>Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª</label>
<select id="drinkSelect">
  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¨</option>
  <option>Ù‡ÙˆØª Ø´ÙˆÙƒÙ„Øª</option>
  <option>Ø³Ø­Ù„Ø¨</option>
  <option>ÙƒØ±Ùƒ</option>
  <option>ÙƒØ§Ø³ØªØ±Ø¯</option>
  <option>Ù‚Ù‡ÙˆØ© Ø¹Ø±Ø¨ÙŠØ©</option>
  <option>Ù‚Ù‡ÙˆØ© ÙØ±Ù†Ø³ÙŠØ©</option>
  <option>Ù‚Ù‡ÙˆØ© Ø§Ù„Ù„ÙˆØ²</option>
  <option>Ø´Ø§Ù‡ÙŠ Ø£Ø­Ù…Ø±</option>
  <option>Ø´Ø§Ù‡ÙŠ ÙƒØ±Ùƒ</option>
  <option>Ø´Ø§Ù‡ÙŠ Ø£Ø®Ø¶Ø±</option>
  <option>ØªÙ…Ø±</option>
  <option>ØªÙ…Ø± Ù…Ø­Ø´ÙŠ</option>
  <option>Ù…Ø¹Ù…ÙˆÙ„</option>
  <option>Ù‚Ù‡ÙˆØ© Ø³ÙˆØ¯Ø§Ø¡</option>
  <option>Ø´Ø§Ù‡ÙŠ Ø§Ø­Ù…Ø±</option>
  <option>Ø¬Ù†Ø²Ø¨ÙŠÙ„ Ù†Ø¹Ù†Ø§Ù†</option>
</select>

<button onclick="addDrink()">Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¨</button>
<ul id="drinkList"></ul>

<label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
<textarea id="notes" rows="3"></textarea>

<label>Ø§Ù„Ø¹Ø±Ø¨Ø©</label>
<select id="cart">
  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¹Ø±Ø¨Ø©</option>
  <option>ÙƒØ¨ÙŠØ±Ø©</option>
  <option>ÙˆØ³Ø·</option>
  <option>ØµØºÙŠØ±Ø©</option>
  <option>ÙˆØ³Ø· + ØµØºÙŠØ±Ø©</option>
</select>

<label>Ø§Ù„ØªØ£Ù…ÙŠÙ†</label>
<input type="number" id="insurance" value="0">

<label>Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ†</label>
<input type="number" id="deposit" value="0" oninput="calc()">

<label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©</label>
<input type="number" id="total" value="0" oninput="calc()">

<label>Ø§Ù„Ø®ØµÙ…</label>
<input type="number" id="discount" value="0" oninput="calc()">

<div class="net">
Ø§Ù„ØµØ§ÙÙŠ: <strong id="net">0</strong>
</div>

<button class="save" onclick="saveOrder()">Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨</button>
<button class="back" onclick="location.href='index.html'">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
</div>

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbwZPZikrqPEPzXi2M6nZ2-leYGXoI-WWEWdxhrmbdR9hx__i0_sfW4HIQ8tx6ZWAH-W/exec";

let drinks=[];

// ğŸŸ¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¥Ù† ÙˆØ¬Ø¯Øª
const editData = JSON.parse(localStorage.getItem("editOrder") || "null");

function addDrink(){
  if(!drinkSelect.value) return;
  drinks.push(drinkSelect.value);
  render();
}

function render(){
  drinkList.innerHTML="";
  drinks.forEach((d,i)=>{
    drinkList.innerHTML+=`
      <li>${d}
        <button class="remove" onclick="del(${i})">âœ–</button>
      </li>`;
  });
}

function del(i){
  drinks.splice(i,1);
  render();
}

function calc(){
  const t = +total.value || 0;
  const d = +discount.value || 0;
  const a = +deposit.value || 0;
  net.textContent = Math.max(t - d - a, 0);
}

/* ğŸŸ¢ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ: Ø¥Ø¶Ø§ÙØ© */
function saveOrder(){
  const order={
    name: customerName.value,
    phone: phone.value,
    bookingDate: bookingDate.value,
    eventDate: eventDate.value,
    drinks: drinks.join("ØŒ "),
    notes: notes.value,
    cart: cart.value,
    insurance: insurance.value,
    deposit: deposit.value,
    discount: discount.value,
    total: total.value,
    net: net.textContent,
    status: "Ø¬Ø¯ÙŠØ¯"
  };

  fetch(SHEET_URL,{
    method:"POST",
    mode:"no-cors",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(order)
  });

  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
  clearForm();
}

/* ğŸŸ¡ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
if(editData){
  title.textContent = "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨";
  document.querySelector(".save").textContent = "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨";

  customerName.value = editData.name || "";
  phone.value = editData.phone || "";
  bookingDate.value = editData.bookingDate || "";
  eventDate.value = editData.eventDate || "";
  notes.value = editData.notes || "";
  cart.value = editData.cart || "";
  insurance.value = editData.insurance || 0;
  deposit.value = editData.deposit || 0;
  discount.value = editData.discount || 0;
  total.value = editData.total || 0;
  net.textContent = editData.net || 0;

  drinks = editData.drinks ? editData.drinks.split("ØŒ ") : [];
  render();

  // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø­ÙØ¸ Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ«
  window.saveOrder = function(){
    const order={
      action:"update",
      rowIndex: editData.rowIndex,
      name: customerName.value,
      phone: phone.value,
      bookingDate: bookingDate.value,
      eventDate: eventDate.value,
      drinks: drinks.join("ØŒ "),
      notes: notes.value,
      cart: cart.value,
      insurance: insurance.value,
      deposit: deposit.value,
      discount: discount.value,
      total: total.value,
      net: net.textContent
    };

    fetch(SHEET_URL,{
      method:"POST",
      mode:"no-cors",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(order)
    });

    localStorage.removeItem("editOrder");
    alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨ âœ…");
    location.href = "orders.html"; // Ø¹Ø¯Ù„ Ø§Ù„Ø§Ø³Ù… Ø¥Ø°Ø§ Ù…Ø®ØªÙ„Ù
  };
}

function clearForm(){
  customerName.value="";
  phone.value="";
  bookingDate.value="";
  eventDate.value="";
  drinks=[];
  render();
  notes.value="";
  cart.value="";
  insurance.value=0;
  deposit.value=0;
  total.value=0;
  discount.value=0;
  net.textContent=0;
}
</script>

</body>
</html>
