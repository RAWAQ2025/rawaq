<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø© - Ø±ÙˆØ§Ù‚</title>

<!-- ğŸ” Ø§Ù„Ø£Ù…Ø§Ù† + Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« -->
<script>
const MAX_TIME = 5 * 60 * 1000;
const loggedIn = sessionStorage.getItem("loggedIn");
const lastLogin = sessionStorage.getItem("lastLogin");

if(!loggedIn || !lastLogin || (Date.now() - lastLogin > MAX_TIME)){
  sessionStorage.clear();
  location.href = "login.html";
}

const nav = performance.getEntriesByType("navigation")[0];
if(nav && nav.type === "reload"){
  sessionStorage.clear();
  location.href = "login.html";
}
</script>

<style>
:root{
  --purple:#4b1f5c;
  --bg:#f4f1f6;
}
body{
  margin:0;
  font-family:Tahoma;
  background:var(--bg);
}
.container{
  max-width:95%;
  margin:20px auto;
  background:#fff;
  padding:15px;
  border-radius:12px;
}
h2{
  text-align:center;
  color:var(--purple);
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
  font-size:14px;
}
th,td{
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
  vertical-align:top;
}
th{
  background:var(--purple);
  color:#fff;
}
.client{
  line-height:1.6;
}
.btn{
  border:none;
  padding:6px 10px;
  border-radius:6px;
  cursor:pointer;
  font-size:12px;
}
.delete{
  background:#dc3545;
  color:#fff;
}
.back{
  margin-top:15px;
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
}
</style>
</head>

<body>

<div class="container">
<h2>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†Ø¬Ø²Ø©</h2>

<table>
<thead>
<tr>
<th>#</th>
<th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
<th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</th>
<th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª</th>
<th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
<th>Ø§Ù„Ø¹Ø±Ø¨Ø©</th>
<th>Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ† / Ø§Ù„ØªØ£Ù…ÙŠÙ†</th>
<th>Ø§Ù„ØµØ§ÙÙŠ</th>
<th>Ø¥Ø¬Ø±Ø§Ø¡</th>
</tr>
</thead>
<tbody id="body"></tbody>
</table>

<button class="back" onclick="location.href='index.html'">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
</div>

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbxqp0aagRTRGcIpQGlIjhyjQi2Kw2G-bOJzQt9pv4qj55tIkxAq569TSBjQ5tgOPajp/exec";

function formatDate(d){
  if(!d) return "";
  return new Date(d).toLocaleDateString("ar-SA");
}

function postAction(payload){
  return fetch(SHEET_URL,{
    method:"POST",
    mode:"no-cors",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
}

function loadDoneOrders(){
  fetch(SHEET_URL)
    .then(r => r.json())
    .then(data => {
      const body = document.getElementById("body");
      body.innerHTML = "";

      data
        .filter(o => o.status === "ØªÙ…")
        .sort((a,b)=>{
          const da = a.eventDate ? new Date(a.eventDate).getTime() : 0;
          const db = b.eventDate ? new Date(b.eventDate).getTime() : 0;
          return da - db; // â¬…ï¸ ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
        })
        .forEach((o,i)=>{
          body.innerHTML += `
          <tr>
            <td>${i+1}</td>
            <td class="client">
              ${o.name || ""}<br>
              ${o.phone || ""}
            </td>
            <td>${formatDate(o.eventDate)}</td>
            <td>${o.drinks || ""}</td>
            <td>${o.notes || ""}</td>
            <td>${o.cart || ""}</td>
            <td>
              Ø¹Ø±Ø¨ÙˆÙ†: ${o.deposit || 0}<br>
              ØªØ£Ù…ÙŠÙ†: ${o.insurance || 0}
            </td>
            <td>${o.net || 0}</td>
            <td>
              <button class="btn delete" onclick="deleteOrder(${o.rowIndex})">
                Ø­Ø°Ù
              </button>
            </td>
          </tr>`;
        });
    });
}

function deleteOrder(rowIndex){
  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ")) return;
  postAction({ action:"delete", rowIndex });
  setTimeout(loadDoneOrders,500);
}

loadDoneOrders();
</script>

</body>
</html>
