<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª - Ø±ÙˆØ§Ù‚</title>

<style>
body{font-family:Tahoma;background:#f4f1f6;margin:0}
.container{
  max-width:700px;
  margin:30px auto;
  background:#fff;
  padding:20px;
  border-radius:12px;
}
h2{text-align:center;color:#4b1f5c}
label{display:block;margin-top:12px;font-weight:bold}
input{
  width:100%;
  padding:10px;
  margin-top:6px;
  border-radius:8px;
  border:1px solid #ccc;
}
.row{
  display:flex;
  gap:10px;
  margin-top:10px;
}
.row input{flex:1}
.addBtn{
  padding:10px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  background:#4b1f5c;
  color:#fff;
}
.save{
  margin-top:15px;
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  background:#4b1f5c;
  color:#fff;
  font-size:16px;
  cursor:pointer;
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
  font-size:14px;
}
th,td{
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
}
th{background:#4b1f5c;color:#fff}
.btn{
  border:none;
  padding:4px 8px;
  border-radius:6px;
  cursor:pointer;
  font-size:12px;
}
.edit{background:#ffc107}
.delete{background:#dc3545;color:#fff}
.total{
  margin-top:10px;
  text-align:left;
  font-weight:bold;
}
.back{
  margin-top:15px;
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  background:#ddd;
  color:#4b1f5c;
}
</style>
</head>

<body>

<!-- ğŸ” Ø§Ù„Ø£Ù…Ø§Ù† + Ù…Ù†Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ« -->
<script>
const MAX_TIME = 5 * 60 * 1000;
const loggedIn = sessionStorage.getItem("loggedIn");
const lastLogin = sessionStorage.getItem("lastLogin");

if(!loggedIn || !lastLogin || (Date.now() - lastLogin > MAX_TIME)){
  sessionStorage.clear();
  location.href = "login.html";
}

const nav = performance.getEntriesByType("navigation")[0];
if(nav && nav.type === "reload"){
  sessionStorage.clear();
  location.href = "login.html";
}
</script>

<div class="container">
  <h2>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</h2>

  <label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØµØ±Ù</label>
  <input type="date" id="expenseDate">

  <div class="row">
    <input id="itemName" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
    <input id="itemAmount" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
    <button type="button" class="addBtn" onclick="addItem()">â•</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Ø§Ù„ØµÙ†Ù</th>
        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
        <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
      </tr>
    </thead>
    <tbody id="tempBody"></tbody>
  </table>

  <button type="button" class="save" onclick="saveExpenses()">Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>

  <hr>

  <table>
    <thead>
      <tr>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø§Ù„ØµÙ†Ù</th>
        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
        <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
      </tr>
    </thead>
    <tbody id="body"></tbody>
  </table>

  <div class="total">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙŠÙˆÙ…: <span id="dayTotal">0</span></div>

  <button class="back" onclick="location.href='index.html'">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwBe3GIdZOkRK82HvlO7153gQI8jkDd_FzdCJlGERDWK7EYI621bN3Y2Oj7BmCCA21F/exec";

let items = [];
let editIndex = null;

/* â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù */
function addItem(){
  if(!itemName.value || !itemAmount.value) return;

  if(editIndex !== null){
    items[editIndex] = { name:itemName.value, amount:Number(itemAmount.value) };
    editIndex = null;
  } else {
    items.push({ name:itemName.value, amount:Number(itemAmount.value) });
  }

  itemName.value="";
  itemAmount.value="";
  renderTemp();
}

function renderTemp(){
  tempBody.innerHTML="";
  items.forEach((it,i)=>{
    tempBody.innerHTML += `
      <tr>
        <td>${i+1}</td>
        <td>${it.name}</td>
        <td>${it.amount}</td>
        <td>
          <button class="btn edit" onclick="editTemp(${i})">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn delete" onclick="removeTemp(${i})">Ø­Ø°Ù</button>
        </td>
      </tr>
    `;
  });
}

function editTemp(i){
  itemName.value = items[i].name;
  itemAmount.value = items[i].amount;
  editIndex = i;
}

function removeTemp(i){
  items.splice(i,1);
  renderTemp();
}

/* ğŸ’¾ Ø­ÙØ¸ ÙÙŠ Google (no-cors) */
function saveExpenses(){
  if(!expenseDate.value || items.length === 0){
    alert("Ø£ÙƒÙ…Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
    return;
  }

  fetch(API_URL,{
    method:"POST",
    mode:"no-cors",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      action:"saveExpenses",
      date: expenseDate.value,
      items: items
    })
  });

  items=[];
  renderTemp();
  loadExpenses();
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª âœ…");
}

/* ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù…Ù† Google */
function loadExpenses(){
  fetch(API_URL)
    .then(r=>r.json())
    .then(data=>{
      body.innerHTML="";
      let total = 0;
      const today = expenseDate.value;

      data
        .sort((a,b)=> new Date(b.date) - new Date(a.date))
        .forEach(e=>{
          if(e.date === today) total += Number(e.amount);

          body.innerHTML += `
            <tr>
              <td>${e.date}</td>
              <td>${e.name}</td>
              <td>${e.amount}</td>
              <td>
                <button class="btn delete" onclick="deleteExp(${e.rowIndex})">Ø­Ø°Ù</button>
              </td>
            </tr>
          `;
        });

      dayTotal.textContent = total;
    });
}

/* ğŸ—‘ï¸ Ø­Ø°Ù */
function deleteExp(rowIndex){
  if(!confirm("Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙØŸ")) return;

  fetch(API_URL,{
    method:"POST",
    mode:"no-cors",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      action:"deleteExpense",
      rowIndex: rowIndex
    })
  });

  loadExpenses();
}

loadExpenses();
</script>

</body>
</html>
