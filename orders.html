<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª - Ø±ÙˆØ§Ù‚</title>

<script>
// ğŸ” Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø© (5 Ø¯Ù‚Ø§Ø¦Ù‚)
const MAX_TIME = 5 * 60 * 1000;
const loggedIn = sessionStorage.getItem("loggedIn");
const lastLogin = sessionStorage.getItem("lastLogin");

if(!loggedIn || !lastLogin || (Date.now() - lastLogin > MAX_TIME)){
  sessionStorage.clear();
  location.href = "login.html";
}
</script>

<style>
:root{
  --purple:#4b1f5c;
  --bg:#f4f1f6;
  --red:#f8d7da;
  --yellow:#fff3cd;
  --green:#d4edda;
}
body{margin:0;font-family:Tahoma,Arial;background:var(--bg);}
.container{max-width:95%;margin:20px auto;background:#fff;padding:15px;border-radius:12px;}
h2{text-align:center;color:var(--purple);}

table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;vertical-align:top;}
th{background:var(--purple);color:#fff;}

.client-box{line-height:1.6;font-size:13px;}
.money-box{font-size:13px;line-height:1.5;}

details summary{cursor:pointer;color:var(--purple);font-weight:bold;}
details ul{padding-right:18px;margin:6px 0 0;text-align:right;}

.btn{
  border:none;
  padding:6px 10px;
  border-radius:6px;
  cursor:pointer;
  font-size:12px;
  margin:2px;
}
.done{background:#4b1f5c;color:#fff;}
.edit{background:#ffc107;}
.delete{background:#dc3545;color:#fff;}

.back-btn{
  margin-top:15px;
  width:100%;
  padding:12px;
  background:#ddd;
  color:#4b1f5c;
  border:none;
  border-radius:10px;
  cursor:pointer;
}

.empty{text-align:center;margin-top:20px;color:#777;}
</style>
</head>

<body>

<div class="container">
<h2>Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>

<table>
<thead>
<tr>
  <th>#</th>
  <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²</th>
  <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</th>
  <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª</th>
  <th>Ø§Ù„Ø¹Ø±Ø¨Ø©</th>
  <th>Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ† / Ø§Ù„ØªØ£Ù…ÙŠÙ†</th>
  <th>Ø§Ù„ØµØ§ÙÙŠ</th>
  <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<div id="emptyMsg" class="empty" style="display:none">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>

<button class="back-btn" onclick="location.href='index.html'">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
</div>

<script>
// ğŸ”— Ø±Ø§Ø¨Ø· Google Apps Script
const SHEET_URL = "https://script.google.com/macros/s/AKfycbw8pGujQ5M2sXPBG4RgZ1uo__t6eMfms_mziWfm0KSYtx_J3bO2VHNou2PNByi_mGHc/exec";

fetch(SHEET_URL)
  .then(r => r.json())
  .then(data => renderTable(data))
  .catch(()=>alert("ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚ÙˆÙ‚Ù„"));

function renderTable(orders){
  const body = document.getElementById("tableBody");
  const emptyMsg = document.getElementById("emptyMsg");
  body.innerHTML = "";

  if(!orders.length){
    emptyMsg.style.display="block";
    return;
  }

  // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
  orders.sort((a,b)=> new Date(a.eventDate) - new Date(b.eventDate));

  const today = new Date();
  let counter = 1;

  orders.forEach(order=>{
    if(order.status !== "Ø¬Ø¯ÙŠØ¯") return;

    const eventDate = new Date(order.eventDate);
    const diffDays = Math.ceil((eventDate - today)/(1000*60*60*24));
    let color = diffDays<=2 ? "var(--red)" : diffDays<=5 ? "var(--yellow)" : "var(--green)";

    const drinksArr = order.drinks ? order.drinks.split("ØŒ") : [];
    const drinksList = drinksArr.map(d=><li>${d}</li>).join("");

    const tr = document.createElement("tr");
    tr.style.background = color;

    tr.innerHTML = `
      <td><strong>${counter++}</strong></td>

      <td class="client-box">
        ${order.name || ""}<br>
        ${order.phone || ""}
      </td>

      <td>${order.bookingDate || ""}</td>
      <td>${order.eventDate || ""}</td>

      <td>
        <details>
          <summary>Ø¹Ø±Ø¶</summary>
          <ul>${drinksList}</ul>
        </details>
      </td>

      <td>${order.cart || ""}</td>

      <td class="money-box">
        Ø¹Ø±Ø¨ÙˆÙ†: ${order.deposit || 0}<br>
        ØªØ£Ù…ÙŠÙ†: ${order.insurance || 0}
      </td>

      <td>${order.net || 0}</td>

      <td>
        <button class="btn done" onclick='markDone(${JSON.stringify(order)})'>ØªÙ…Øª Ø§Ù„Ø®Ø¯Ù…Ø©</button>
        <button class="btn edit" onclick='editOrder(${JSON.stringify(order)})'>ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn delete" onclick='deleteOrder(${JSON.stringify(order)})'>Ø­Ø°Ù</button>
      </td>
    `;
    body.appendChild(tr);
  });
}

// âœ… ØªÙ…Øª Ø§Ù„Ø®Ø¯Ù…Ø©
function markDone(order){
  if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ")) return;

  fetch(SHEET_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      action:"done",
      name: order.name,
      phone: order.phone
    })
  }).then(()=>{
    alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© âœ…");
    location.reload();
  });
}

// âœ… Ø­Ø°Ù
function deleteOrder(order){
  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;

  fetch(SHEET_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      action:"delete",
      name: order.name,
      phone: order.phone
    })
  }).then(()=>{
    alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ âœ…");
    location.reload();
  });
}

// âœ… ØªØ¹Ø¯ÙŠÙ„
function editOrder(order){
  localStorage.setItem("editOrder", JSON.stringify(order));
  location.href = "add.html";
}
</script>

</body>
</html>
