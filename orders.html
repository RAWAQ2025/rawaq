<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª - Ø±ÙˆØ§Ù‚</title>

<script>
/* ğŸ” Ø­Ù…Ø§ÙŠØ© Ø§Ù„ØµÙØ­Ø© */
if(!sessionStorage.getItem("loggedIn")){
  location.replace("login.html");
}
</script>

<style>
:root{
  --purple:#4b1f5c;
  --bg:#f4f1f6;
  --red:#f8d7da;
  --yellow:#fff3cd;
  --green:#d4edda;
}
body{
  margin:0;
  font-family:Tahoma,Arial;
  background:var(--bg);
}
.container{
  max-width:95%;
  margin:20px auto;
  background:#fff;
  padding:15px;
  border-radius:12px;
}
h2{
  text-align:center;
  color:var(--purple);
}
table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
  font-size:14px;
}
th,td{
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
  vertical-align:top;
}
th{
  background:var(--purple);
  color:#fff;
}
details summary{
  cursor:pointer;
  color:var(--purple);
  font-weight:bold;
}
details ul{
  padding-right:18px;
  margin:6px 0 0;
  text-align:right;
}
.client-box,.money-box{
  line-height:1.6;
  font-size:13px;
}
.btn{
  border:none;
  padding:5px 8px;
  border-radius:6px;
  cursor:pointer;
  font-size:12px;
  margin:2px;
}
.done{background:#4b1f5c;color:#fff;}
.edit{background:#ffc107;}
.delete{background:#dc3545;color:#fff;}
.back-btn{
  margin-top:15px;
  width:100%;
  padding:12px;
  background:#ddd;
  color:#4b1f5c;
  border:none;
  border-radius:10px;
  cursor:pointer;
}
.empty{
  text-align:center;
  margin-top:20px;
  color:#777;
}
</style>
</head>

<body>

<div class="container">
  <h2>Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</th>
        <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª</th>
        <th>Ø§Ù„Ø¹Ø±Ø¨Ø©</th>
        <th>Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ† / Ø§Ù„ØªØ£Ù…ÙŠÙ†</th>
        <th>Ø§Ù„ØµØ§ÙÙŠ</th>
        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <div id="emptyMsg" class="empty" style="display:none">
    Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª
  </div>

  <button class="back-btn" onclick="location.href='index.html'">
    Ø§Ù„Ø¹ÙˆØ¯Ø©
  </button>
</div>

<script>
/* ğŸ“¦ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª */
let orders = JSON.parse(localStorage.getItem("orders") || "[]");

const body = document.getElementById("tableBody");
const emptyMsg = document.getElementById("emptyMsg");

/* ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© */
orders.sort((a,b)=> new Date(a.eventDate || 0) - new Date(b.eventDate || 0));

let today = new Date();
let counter = 1;
let hasOrders = false;

orders.forEach((order, index)=>{
  if(order.status === "Ø¬Ø¯ÙŠØ¯"){
    hasOrders = true;

    /* ğŸ§  Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
    const name = order.name || "â€”";
    const phone = order.phone || "";
    const eventDateText = order.eventDate || "";

    /* Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª: Ù†Øµ Ø£Ùˆ Ù…ØµÙÙˆÙØ© */
    let drinksArr = [];
    if(Array.isArray(order.drinks)){
      drinksArr = order.drinks;
    }else if(typeof order.drinks === "string"){
      drinksArr = order.drinks.split("ØŒ ");
    }

    const drinksList = drinksArr
      .map(d=>`<li>${d}</li>`)
      .join("");

    /* Ø£Ù„ÙˆØ§Ù† Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® */
    const eventDate = new Date(order.eventDate);
    const diffDays = Math.ceil((eventDate - today)/(1000*60*60*24));
    let color =
      diffDays <= 2 ? "var(--red)" :
      diffDays <= 5 ? "var(--yellow)" :
      "var(--green)";

    const tr = document.createElement("tr");
    tr.style.background = color;

    tr.innerHTML = `
      <td><strong>${counter++}</strong></td>
      <td class="client-box">${name}<br>${phone}</td>
      <td>${eventDateText}</td>
      <td>
        <details>
          <summary>Ø¹Ø±Ø¶</summary>
          <ul>${drinksList}</ul>
        </details>
      </td>
      <td>${order.cart || ""}</td>
      <td class="money-box">
        Ø¹Ø±Ø¨ÙˆÙ†: ${order.deposit || 0}<br>
        ØªØ£Ù…ÙŠÙ†: ${order.insurance || 0}
      </td>
      <td>${order.net || 0}</td>
      <td>
        <button class="btn done" onclick="markDone(${index})">ØªÙ…</button>
        <button class="btn edit" onclick="editOrder(${index})">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn delete" onclick="deleteOrder(${index})">Ø­Ø°Ù</button>
      </td>
    `;

    body.appendChild(tr);
  }
});

if(!hasOrders){
  emptyMsg.style.display = "block";
}

/* âœ… Ø§Ù„Ø¯ÙˆØ§Ù„ */
function markDone(i){
  orders[i].status = "ØªÙ…";
  localStorage.setItem("orders", JSON.stringify(orders));
  location.href = "completed.html";
}

function deleteOrder(i){
  if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ØŸ")){
    orders.splice(i,1);
    localStorage.setItem("orders", JSON.stringify(orders));
    location.reload();
  }
}

function editOrder(i){
  localStorage.setItem("editIndex", i);
  location.href = "add.html";
}
</script>

</body>
</html>
