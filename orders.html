<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª - Ø±ÙˆØ§Ù‚</title>

<!-- ğŸ” Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø© (5 Ø¯Ù‚Ø§Ø¦Ù‚) -->
<script>
const MAX_TIME = 5 * 60 * 1000;
const loggedIn = sessionStorage.getItem("loggedIn");
const lastLogin = sessionStorage.getItem("lastLogin");

if(!loggedIn || !lastLogin || (Date.now() - lastLogin > MAX_TIME)){
  sessionStorage.clear();
  location.href = "login.html";
}
</script>

<style>
:root{
  --purple:#4b1f5c;
  --bg:#f4f1f6;
  --red:#f8d7da;
  --yellow:#fff3cd;
  --green:#d4edda;
}
body{margin:0;font-family:Tahoma;background:var(--bg);}
.container{max-width:95%;margin:20px auto;background:#fff;padding:15px;border-radius:12px;}
h2{text-align:center;color:var(--purple);}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;vertical-align:top;}
th{background:var(--purple);color:#fff;}
details summary{cursor:pointer;color:var(--purple);font-weight:bold;}
details ul{padding-right:18px;margin:6px 0 0;text-align:right;}
.back-btn{margin-top:15px;width:100%;padding:12px;background:#ddd;color:#4b1f5c;border:none;border-radius:10px;}
.empty{text-align:center;margin-top:20px;color:#777;}
</style>
</head>

<body>
<div class="container">
<h2>Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>

<table>
<thead>
<tr>
  <th>#</th>
  <th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
  <th>ØªØ§Ø±ÙŠØ® / ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</th>
  <th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª</th>
  <th>Ø§Ù„Ø¹Ø±Ø¨Ø©</th>
  <th>Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ† / Ø§Ù„ØªØ£Ù…ÙŠÙ†</th>
  <th>Ø§Ù„ØµØ§ÙÙŠ</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<div id="emptyMsg" class="empty" style="display:none">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª</div>
<button class="back-btn" onclick="location.href='index.html'">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
</div>

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycbz3WF2BOH1Lyma_PfxnNFd639kpi9LMsH9z_r6kpYx4pEJXUTOiz7Hl1jqr7RVQD0Tg/exec";

fetch(SHEET_URL)
  .then(res => res.json())
  .then(data => {
    const body = document.getElementById("tableBody");
    const emptyMsg = document.getElementById("emptyMsg");
    const today = new Date();

    if(!data || data.length === 0){
      emptyMsg.style.display = "block";
      return;
    }

    // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø£Ù‚Ø±Ø¨ ØªØ§Ø±ÙŠØ® + ÙˆÙ‚Øª
    data.sort((a,b)=>{
      const da = new Date(a.eventDate + " " + (a.eventTime || "00:00"));
      const db = new Date(b.eventDate + " " + (b.eventTime || "00:00"));
      return da - db;
    });

    data.forEach((o,i)=>{
      const eventDate = new Date(o.eventDate + " " + (o.eventTime || "00:00"));
      const diffDays = Math.ceil((eventDate - today)/(1000*60*60*24));

      let color =
        diffDays <= 2 ? "var(--red)" :
        diffDays <= 5 ? "var(--yellow)" :
        "var(--green)";

      const tr = document.createElement("tr");
      tr.style.background = color;

      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${o.name || ""}</td>
        <td>${o.eventDate || ""}<br>${o.eventTime || ""}</td>
        <td>${o.drinks || ""}</td>
        <td>${o.cart || ""}</td>
        <td>Ø¹Ø±Ø¨ÙˆÙ†: ${o.deposit || 0}<br>ØªØ£Ù…ÙŠÙ†: ${o.insurance || 0}</td>
        <td>${o.net || 0}</td>
      `;

      body.appendChild(tr);
    });
  })
  .catch(() => {
    alert("ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Ù‚ÙˆÙ‚Ù„");
  });
</script>

</body>
</html>
