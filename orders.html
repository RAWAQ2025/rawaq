<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>عرض الطلبات - رواق</title>

<style>
:root{
  --purple:#4b1f5c;
  --bg:#f4f1f6;
  --red:#f8d7da;
  --yellow:#fff3cd;
  --green:#d4edda;
}
body{margin:0;font-family:Tahoma;background:var(--bg);}
.container{max-width:95%;margin:20px auto;background:#fff;padding:15px;border-radius:12px;}
h2{text-align:center;color:var(--purple);}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;vertical-align:top;}
th{background:var(--purple);color:#fff;}
.client{line-height:1.6}
.btn{border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px;margin:2px}
.done{background:#4b1f5c;color:#fff}
.edit{background:#ffc107}
.delete{background:#dc3545;color:#fff}
.back{margin-top:15px;width:100%;padding:12px;border:none;border-radius:10px}
</style>
</head>

<body>

<div class="container">
  <h2>عرض الطلبات</h2>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>العميل</th>
        <th>تاريخ الحجز</th>
        <th>تاريخ المناسبة</th>
        <th>المشروبات</th>
        <th>العربة</th>
        <th>العربون / التأمين</th>
        <th>الصافي</th>
        <th>إجراءات</th>
      </tr>
    </thead>
    <tbody id="body"></tbody>
  </table>

  <button class="back" onclick="location.href='index.html'">العودة</button>
</div>

<script>
/* تنسيق التاريخ */
function formatDate(d){
  if(!d) return "";
  return new Date(d).toLocaleDateString("ar-SA");
}

/* تحميل الطلبات من Google */
google.script.run.withSuccessHandler(function(data){
  const body = document.getElementById("body");
  const today = new Date();
  body.innerHTML = "";

  data
    .filter(o => o.status === "جديد")
    .sort((a,b)=> new Date(a.eventDate) - new Date(b.eventDate))
    .forEach((o,i)=>{
      const diff = Math.ceil((new Date(o.eventDate)-today)/(1000*60*60*24));
      const color =
        diff <= 2 ? "var(--red)" :
        diff <= 5 ? "var(--yellow)" :
        "var(--green)";

      body.innerHTML += `
        <tr style="background:${color}">
          <td>${i+1}</td>
          <td class="client">
            ${o.name || ""}<br>
            ${o.phone || ""}
          </td>
          <td>${formatDate(o.bookingDate)}</td>
          <td>${formatDate(o.eventDate)}</td>
          <td>${o.drinks || ""}</td>
          <td>${o.cart || ""}</td>
          <td>
            عربون: ${o.deposit || 0}<br>
            تأمين: ${o.insurance || 0}
          </td>
          <td>${o.net || 0}</td>
          <td>
            <button class="btn done" onclick="markDone(${o.rowIndex})">تمت</button>
            <button class="btn edit" onclick='editOrder(${JSON.stringify(o)})'>تعديل</button>
            <button class="btn delete" onclick="deleteOrder(${o.rowIndex})">حذف</button>
          </td>
        </tr>
      `;
    });
}).getOrders();

/* تمت */
function markDone(rowIndex){
  if(!confirm("تأكيد تمت الخدمة؟")) return;
  google.script.run
    .withSuccessHandler(()=> location.reload())
    .markOrderDone(rowIndex);
}

/* حذف */
function deleteOrder(rowIndex){
  if(!confirm("هل أنت متأكد من حذف الطلب؟")) return;
  google.script.run
    .withSuccessHandler(()=>{
      alert("تم حذف الطلب");
      location.reload();
    })
    .deleteOrder(rowIndex);
}

/* تعديل */
function editOrder(order){
  sessionStorage.setItem("editOrder", JSON.stringify(order));
  location.href = "add.html";
}
</script>

</body>
</html>
