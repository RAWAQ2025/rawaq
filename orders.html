<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª - Ø±ÙˆØ§Ù‚</title>

<script>
// ğŸ” Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø© (5 Ø¯Ù‚Ø§Ø¦Ù‚)
const MAX_TIME = 5 * 60 * 1000;
const loggedIn = sessionStorage.getItem("loggedIn");
const lastLogin = sessionStorage.getItem("lastLogin");

if(!loggedIn || !lastLogin || (Date.now() - lastLogin > MAX_TIME)){
  sessionStorage.clear();
  location.href = "login.html";
}
</script>

<style>
:root{
  --purple:#4b1f5c;
  --bg:#f4f1f6;
  --red:#f8d7da;
  --yellow:#fff3cd;
  --green:#d4edda;
}
body{margin:0;font-family:Tahoma;background:var(--bg);}
.container{max-width:95%;margin:20px auto;background:#fff;padding:15px;border-radius:12px;}
h2{text-align:center;color:var(--purple);}
table{width:100%;border-collapse:collapse;margin-top:15px;font-size:14px;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;vertical-align:top;}
th{background:var(--purple);color:#fff;}
.client{line-height:1.6}
.btn{border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px;margin:2px}
.done{background:#4b1f5c;color:#fff}
.edit{background:#ffc107}
.delete{background:#dc3545;color:#fff}
.back{margin-top:15px;width:100%;padding:12px;border:none;border-radius:10px}
</style>
</head>

<body>
<div class="container">
<h2>Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>

<table>
<thead>
<tr>
<th>#</th>
<th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th>
<th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²</th>
<th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©</th>
<th>Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª</th>
<th>Ø§Ù„Ø¹Ø±Ø¨Ø©</th>
<th>Ø§Ù„Ø¹Ø±Ø¨ÙˆÙ† / Ø§Ù„ØªØ£Ù…ÙŠÙ†</th>
<th>Ø§Ù„ØµØ§ÙÙŠ</th>
<th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody id="body"></tbody>
</table>

<button class="back" onclick="location.href='index.html'">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
</div>

<script>
const SHEET_URL = "https://script.google.com/macros/s/AKfycby-Nd3SwB312KziI8yT-nsajMhmXCCs54oRDpYirJ32WdI8gmpILl4KSVAeEymW0HaQ/exec";

function postAction(payload){
  return fetch(SHEET_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
}
  function formatDate(d){
  if(!d) return "";
  const date = new Date(d);
  return date.toLocaleDateString("ar-SA");
}
fetch(SHEET_URL)
.then(r => r.json())
.then(data => {
  const body = document.getElementById("body");
  const today = new Date();

  data
    .filter(o => o.status === "Ø¬Ø¯ÙŠØ¯")
    .sort((a,b)=> new Date(a.eventDate) - new Date(b.eventDate))
    .forEach((o,i)=>{
      const diff = Math.ceil((new Date(o.eventDate)-today)/(1000*60*60*24));
      const color = diff<=2 ? "var(--red)" : diff<=5 ? "var(--yellow)" : "var(--green)";

      body.innerHTML += `
      <tr style="background:${color}">
        <td>${i+1}</td>
        <td class="client">${o.name || ""}<br>${o.phone || ""}</td>
      <td>${formatDate(o.eventDate)}</td>
<td>${formatDate(o.bookingDate)}</td>
        <td>${o.drinks || ""}</td>
        <td>${o.cart || ""}</td>
        <td>Ø¹Ø±Ø¨ÙˆÙ†: ${o.deposit}<br>ØªØ£Ù…ÙŠÙ†: ${o.insurance}</td>
        <td>${o.net}</td>
        <td>
          <button class="btn done" onclick="markDone(${o.rowIndex})">ØªÙ…Øª</button>
          <button class="btn edit" onclick='editOrder(${JSON.stringify(o)})'>ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn delete" onclick="deleteOrder(${o.rowIndex})">Ø­Ø°Ù</button>
        </td>
      </tr>`;
    });
});

function markDone(rowIndex){
  if(!confirm("ØªØ£ÙƒÙŠØ¯ ØªÙ…Øª Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ")) return;
  postAction({ action:"done", rowIndex })
    .then(()=> location.reload());
}

function deleteOrder(rowIndex){
  if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ØŸ")) return;

  fetch(SHEET_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      action: "delete",
      rowIndex: rowIndex
    })
  })
  .then(() => {
    alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨");
    location.reload();
  })
  .catch(() => {
    alert("ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù");
  });
}

function editOrder(order){
  localStorage.setItem("editOrder", JSON.stringify(order));
  location.href = "add.html";
}
</script>

</body>
</html>
